<div style="height: 100%;">
  <div ng-if="!ruleEditorIsOpen" style="height: 100%;" title="Edit this rule, or change its destination">
    <div class="oppia-readonly-rule-tile protractor-test-edit-rule" ng-class="{'oppia-editable-section': isEditable}">
      <div class="oppia-click-to-start-editing" ng-click="openRuleEditor()">
      </div>

      <div style="position: relative;">
        <img src="/images/user_mint_48px.png" class="oppia-editor-avatar" style="top: -2px;">
      </div>

      <div>
        <span ng-if="isEditable" class="glyphicon glyphicon-pencil oppia-editor-edit-icon pull-right" title="Edit Rule"></span>

        <span ng-if="rule.description !== 'Default'" style="word-wrap: break-word;">
          <span ng-if="!answerChoices">
            [<em><[rule | parameterizeRuleDescription: getAnswerChoices()]>...</em>]
          </span>
          <span ng-if="answerChoices">
            [<em><span angular-html-bind="rule | parameterizeRuleDescription: answerChoices"></span>...</em>]
          </span>
        </span>
        <span ng-if="rule.description === 'Default'">
          [<em>Answer is not recognized...</em>]
        </span>
      </div>

      <br>

      <div style="position: relative;">
        <img src="/images/oppia_favicon_black_48px.png" style="position: absolute; left: -40px; top: -2px; height: 24px; width: 24px;">
        <span ng-if="isRuleConfusing()">
          <span class="oppia-rule-warning-text">
            <span class="glyphicon glyphicon-warning-sign"></span>
            Please give Oppia something useful to say here.
          </span>
        </span>
        <span ng-if="!isRuleConfusing() && rule.feedback.length === 0" style="color: #888">
          [<em>says nothing...</em>]
        </span>
        <span ng-if="rule.feedback.length > 0" style="word-wrap: break-word;">
          <span angular-html-bind="rule.feedback[0]"></span>
          <span ng-if="rule.feedback.length > 1">
            <em>
              (or <span ng-if="rule.feedback.length > 2">one of </span> <[rule.feedback.length - 1]> other variation<span ng-if="rule.feedback.length > 2">s</span>)
            </em>
          </span>
        </span>
      </div>

      <br>

      <div style="padding-bottom: 20px;" ng-if="rule.dest !== getActiveStateName()">
        Destination:
        <span style="position: relative;">
          <a ng-click="navigateToRuleDest()" ng-if="rule.dest !== 'END'" class="oppia-rule-dest-link">
            <[rule.dest]>
          </a>
        </span>
        <span ng-if="rule.dest === 'END'">
          END
        </span>
      </div>
    </div>
  </div>

  <div ng-if="isEditable && ruleEditorIsOpen">
    <div>
      <div style="position: relative;">
        <img src="/images/user_mint_48px.png" class="oppia-editor-avatar" style="top: -2px;">
        <span ng-if="rule.description !== 'Default'">
          <rule-description-editor current-rule-description="$parent.$parent.rule.description" current-rule-definition="$parent.$parent.rule.definition"></rule-description-editor>
        </span>

        <span ng-if="rule.description === 'Default'">
          If answer is not recognized...
        </span>
      </div>

      <hr>

      <div class="oppia-rule-edit-feedback protractor-test-feedback-bubble">
        <img src="/images/oppia_favicon_black_48px.png" style="position: absolute; left: -40px; top: -2px; height: 24px; width: 24px;">
        <span ng-if="rule.feedback.length > 1">
          (<em>Oppia picks one of these at random</em>):
        </span>
        <span ng-if="rule.feedback.length == 0">
          <em>No feedback specified.</em>
        </span>

        <schema-based-editor schema="RULE_FEEDBACK_SCHEMA" local-value="$parent.rule.feedback">
        </schema-based-editor>
      </div>

      <hr>

      <div class="form-inline protractor-test-dest-bubble" style="margin-bottom: 10px;">
        <div class="form-group" style="font-size: 1.1em;">
          <label for="ruleDestination">Destination:</label>
          <span ng-if="!reloadingDestinations">
            <select class="form-control" ng-model="rule.dest" ng-change="createNewDestIfNecessary()" ng-options="choice.id as choice.text for choice in destChoices" style="margin-left: 10px; width: 200px;">
            </select>
          </span>
        </div>
      </div>
    </div>

    <div class="oppia-rule-save-cancel-buttons">
      <button type="button" class="btn btn-success protractor-test-save-rule" ng-disabled="!rule.description" ng-click="saveThisRule()">Save Rule</button>
      <button type="button" class="btn btn-default" ng-click="cancelThisEdit()">Cancel</button>
      <button type="button" class="btn btn-danger pull-right protractor-test-delete-rule" ng-if="!isDefaultRule()" ng-click="deleteThisRule()">Delete Rule</button>
    </div>
  </div>
</div>

<script type="text/ng-template" id="modals/addState">
  <div class="modal-header">
    <h3>Add New State</h3>
  </div>

  <div class="modal-body">
    <div ng-show="isEditable">
      <form role="form" class="form-inline">
        <div class="form-group">
          <input type="text" class="form-control protractor-test-add-state-input" ng-model="newStateName" placeholder="New State Name" focus-on="newStateNameInput">
        </div>
      </form>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-default" ng-click="cancel()">Cancel</button>
    <button class="btn btn-success protractor-test-add-state-submit"
            ng-click="submit(newStateName)"
            ng-disabled="!isNewStateNameValid(newStateName)">
      Add State
    </button>
  </div>
</script>

<script type="text/ng-template" id="rules/ruleDescriptionEditor">
  <form class="form-inline" role="form">
    Answer
    <rule-type-selector class="protractor-test-rule-description" all-rule-types="allRuleTypes" local-value="currentRuleDescription" on-selection-change="onSelectNewRuleType()">
    </rule-type-selector>

    <span ng-repeat="item in ruleDescriptionFragments track by $index" class="form-group protractor-test-rule-description-fragment">
      <span ng-if="item.type == 'select'" style="color: black;">
        <select class="form-control" ng-model="currentRuleDefinition.inputs[item.varName]" ng-options="choice.id as (choice.val|convertRuleChoiceToPlainText|truncate) for choice in ruleDescriptionChoices" style="max-width: 250px;">
        </select>
      </span>

      <span ng-if="item.type != 'select' && item.type != 'noneditable'">
        <object-editor obj-type="<[item.type]>" is-editable="isEditable" always-editable="true" value="currentRuleDefinition.inputs[item.varName]" style="color: black;"></object-editor>
      </span>
      <span ng-if="item.type == 'noneditable'">
        <[item.text]>
      </span>
    </span>
  </form>
</script>
