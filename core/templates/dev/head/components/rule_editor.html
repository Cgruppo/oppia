<div style="height: 100%;">
  <div ng-if="!ruleEditorIsOpen" class="protractor-test-edit-rule"
       ng-class="{'oppia-editable-section': isEditable}"
       style="height: 100%;">

    <div class="oppia-click-to-start-editing" ng-click="openRuleEditor()">
    </div>

    <div class="oppia-readonly-rule-tile well well-sm" style="height: 100%;">
      <div class="row">
        <div class="col-lg-1 col-md-1 col-sm-1">
          <img src="/images/user.png">
        </div>

        <div class="col-lg-11 col-md-11 col-sm-11">
          <div>
            <span ng-if="isEditable" class="glyphicon glyphicon-pencil oppia-editor-edit-icon pull-right" title="Edit Rule"></span>

            <span ng-if="rule.description !== 'Default'" style="word-wrap: break-word;">
              <span ng-if="!answerChoices">
                [<em><[rule | parameterizeRuleDescription: answerChoices]>...</em>]
              </span>
              <span ng-if="answerChoices">
                [<em><span angular-html-bind="rule | parameterizeRuleDescription: answerChoices"></span>...</em>]
              </span>
            </span>
            <span ng-if="rule.description === 'Default'">
              ...
            </span>

          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 10px;">
        <div class="col-lg-1 col-md-1 col-sm-1">
          <img src="/images/oppia_favicon_mint.png">
        </div>

        <div class="col-lg-11 col-md-11 col-sm-11">
          <div ng-if="isRuleConfusing() || rule.feedback.length > 0">
            <span ng-if="isRuleConfusing()">
              <span class="glyphicon glyphicon-warning-sign"></span>
              <span class="oppia-rule-warning-text">
                Please provide a feedback message.
              </span>
            </span>
            <span ng-if="rule.feedback.length > 0" style="word-wrap: break-word;">
              <span angular-html-bind="rule.feedback[0]"></span>
              <span ng-if="rule.feedback.length > 1">
                <em>
                  (or <span ng-if="rule.feedback.length > 2">one of </span> <[rule.feedback.length - 1]> other variation<span ng-if="rule.feedback.length > 2">s</span>)
                </em>
              </span>
            </span>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 10px;">
        <div style="text-align: center;">
          <div ng-if="rule.dest === getActiveStateName()">
            <div style="font-size: 1.5em;">
              <span class="glyphicon glyphicon-repeat"></span>
            </div>
          </div>
          <div ng-if="rule.dest !== getActiveStateName()">
            <div style="font-size: 2em;">
              ↓
            </div>
            <div>
              <[rule.dest]>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div ng-if="isEditable && ruleEditorIsOpen" class="oppia-rule-editable-view">
    <div class="oppia-rule-bubble">
      <span ng-if="rule.description !== 'Default'">
        <rule-description-editor current-rule-description="$parent.$parent.rule.description" current-rule-definition="$parent.$parent.rule.definition" interaction-handler-specs="interactionHandlerSpecs" answer-choices="answerChoices"></rule-description-editor>
      </span>

      <span ng-if="rule.description === 'Default'">
        If no other rules apply...
      </span>
    </div>

    <div class="oppia-feedback-and-dest">
      <div class="oppia-feedback-bubble protractor-test-feedback-bubble">
        <span ng-if="rule.feedback.length > 0">
          Feedback
          <span ng-if="rule.feedback.length > 1">
            (<em>one variation is chosen at random</em>):
          </span>
        </span>
        <span ng-if="rule.feedback.length == 0">
          <em>No feedback specified.</em>
        </span>

        <schema-based-editor schema="RULE_FEEDBACK_SCHEMA" local-value="$parent.rule.feedback">
        </schema-based-editor>
      </div>

      <div class="oppia-dest-bubble protractor-test-dest-bubble">
        <div class="oppia-align-center">
          <strong>Destination:</strong><br />
          <select2-dropdown width="150" item="rule.dest" choices="destChoices" placeholder="Type destination state name" new-choice-regex="^[A-Z a-z0-9\.]+$" dropdown-css-class="oppia-rule-dest-select2" format-new-selection="convertNewDestToText" invalid-search-term-message="Invalid state name">
          </select2-dropdown>
          <span ng-if="rule.dest == stateName"> ⟳ </span><br />
        </div>
      </div>
    </div>

    <div class="oppia-rule-save-cancel-buttons">
      <button type="button" class="btn btn-success protractor-test-save-rule" ng-disabled="!rule.description" ng-click="saveThisRule()">Save Rule</button>
      <button type="button" class="btn btn-default" ng-click="cancelThisEdit()">Cancel</button>
      <button type="button" class="btn btn-danger pull-right protractor-test-delete-rule" ng-if="!isDefaultRule()" ng-click="deleteThisRule()">Delete Rule</button>
    </div>
  </div>
</div>


<script type="text/ng-template" id="rules/ruleDescriptionEditor">
  <form class="form-inline" role="form">
    Answer
    <rule-type-selector class="protractor-test-rule-description" all-rule-types="allRuleTypes" local-value="currentRuleDescription" on-selection-change="onSelectNewRuleType()">
    </rule-type-selector>

    <span ng-repeat="item in ruleDescriptionFragments track by $index" class="form-group protractor-test-rule-description-fragment">
      <span ng-if="item.type == 'select'" style="color: black;">
        <select class="form-control" ng-model="currentRuleDefinition.inputs[item.varName]" ng-options="choice.id as (choice.val|convertRuleChoiceToPlainText|truncate) for choice in ruleDescriptionChoices">
        </select>
      </span>

      <span ng-if="item.type != 'select' && item.type != 'noneditable'">
        <object-editor obj-type="<[item.type]>" is-editable="isEditable" always-editable="true" value="currentRuleDefinition.inputs[item.varName]" style="color: black;"></object-editor>
      </span>
      <span ng-if="item.type == 'noneditable'">
        <[item.text]>
      </span>
    </span>
  </form>
</script>
