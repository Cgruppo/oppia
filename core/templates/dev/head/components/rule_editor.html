<div style="height: 100%;">
  <div ng-if="!ruleEditorIsOpen" style="height: 100%; margin-left: 55px;" title="Edit this rule, or change its destination">
    <div class="oppia-readonly-rule-tile protractor-test-edit-rule" ng-class="{'oppia-editable-section': isEditable}">
      <div class="oppia-click-to-start-editing" ng-click="openRuleEditor()">
      </div>

      <div style="position: relative;">
        <img src="/images/user.png" class="oppia-rule-user-avatar" style="left: -65px; top: -2px;">
      </div>

      <div>
        <span ng-if="isEditable" class="glyphicon glyphicon-pencil oppia-editor-edit-icon pull-right" title="Edit Rule"></span>

        <span ng-if="rule.description !== 'Default'" style="word-wrap: break-word;">
          <span ng-if="!answerChoices">
            [<em><[rule | parameterizeRuleDescription: getAnswerChoices()]>...</em>]
          </span>
          <span ng-if="answerChoices">
            [<em><span angular-html-bind="rule | parameterizeRuleDescription: answerChoices"></span>...</em>]
          </span>
        </span>
        <span ng-if="rule.description === 'Default'">
          ...
        </span>
      </div>

      <br>

      <div style="position: relative;">
        <img src="/images/oppia_favicon_mint.png" class="oppia-rule-oppia-avatar">
        <span ng-if="isRuleConfusing()">
          <span class="oppia-rule-warning-text">
            <span class="glyphicon glyphicon-warning-sign"></span>
            Please specify something for Oppia to say.
          </span>
        </span>
        <span ng-if="rule.feedback.length > 0" style="word-wrap: break-word;">
          <span angular-html-bind="rule.feedback[0]"></span>
          <span ng-if="rule.feedback.length > 1">
            <em>
              (or <span ng-if="rule.feedback.length > 2">one of </span> <[rule.feedback.length - 1]> other variation<span ng-if="rule.feedback.length > 2">s</span>)
            </em>
          </span>
        </span>
      </div>

      <div style="margin-top: 10px;">
        <div style="text-align: center;">
          <div ng-if="rule.dest === getActiveStateName()">
            <div style="font-size: 1.5em;">
              <span class="glyphicon glyphicon-repeat"></span>
            </div>
          </div>
          <div ng-if="rule.dest !== getActiveStateName()">
            <div style="font-size: 2em;">
              â†“
            </div>
          </div>
        </div>
      </div>
      <div ng-if="rule.dest !== getActiveStateName()" style="padding-bottom: 20px;">
        <div style="text-align: center;">
          <a ng-click="navigateToRuleDest()" ng-if="rule.dest !== 'END'" class="oppia-rule-dest-link">
            <[rule.dest]>
          </a>
          <span ng-if="rule.dest === 'END'">
            END
          </span>
        </div>
      </div>
    </div>
  </div>

  <div ng-if="isEditable && ruleEditorIsOpen">
    <div class="oppia-rule-editable-view">
      <div style="border: 1px solid #ccc; padding: 15px;">
        <div style="position: relative;">
          <img src="/images/user.png" class="oppia-rule-user-avatar" style="left: -70px; top: 2px;">
          <span ng-if="rule.description !== 'Default'">
            <rule-description-editor current-rule-description="$parent.$parent.rule.description" current-rule-definition="$parent.$parent.rule.definition"></rule-description-editor>
          </span>

          <span ng-if="rule.description === 'Default'">
            If no other rules apply...
          </span>
        </div>

        <hr>

        <div class="oppia-rule-edit-feedback protractor-test-feedback-bubble">
          <img src="/images/oppia_favicon_mint.png" class="oppia-rule-oppia-avatar" style="left: -70px;">
          <span ng-if="rule.feedback.length > 1">
            (<em>Oppia picks one of these at random</em>):
          </span>
          <span ng-if="rule.feedback.length == 0">
            <em>No feedback specified.</em>
          </span>

          <schema-based-editor schema="RULE_FEEDBACK_SCHEMA" local-value="$parent.rule.feedback">
          </schema-based-editor>
        </div>

        <hr>

        <div class="protractor-test-dest-bubble">
          <span style="font-size: 1.1em; margin-right: 8px;">
            Destination:
          </span>
          <span ng-if="!reloadingDestinations" style="width: 200px;">
            <select2-dropdown width="150" item="rule.dest" choices="destChoices" placeholder="Type destination state name" new-choice-regex=".^" dropdown-css-class="oppia-rule-dest-select2" format-new-selection="convertNewDestToText" invalid-search-term-message="Invalid state name">
            </select2-dropdown>
          </span>

          <span style="margin: 0 10px;">
            or
          </span>

          <button type="button" class="btn btn-default protractor-test-add-state-button" ng-click="openAddStateModal(rule)">
            <span class="glyphicon glyphicon-plus">
            </span>
            Create New
          </button>
        </div>
      </div>

      <div class="oppia-rule-save-cancel-buttons">
        <button type="button" class="btn btn-success protractor-test-save-rule" ng-disabled="!rule.description" ng-click="saveThisRule()">Save Rule</button>
        <button type="button" class="btn btn-default" ng-click="cancelThisEdit()">Cancel</button>
        <button type="button" class="btn btn-danger pull-right protractor-test-delete-rule" ng-if="!isDefaultRule()" ng-click="deleteThisRule()">Delete Rule</button>
      </div>
    </div>
  </div>
</div>

<script type="text/ng-template" id="modals/addState">
  <div class="modal-header">
    <h3>Add New State</h3>
  </div>

  <div class="modal-body">
    <div ng-show="isEditable">
      <form role="form" class="form-inline">
        <div class="form-group">
          <input type="text" class="form-control protractor-test-add-state-input" ng-model="newStateName" placeholder="New State Name" focus-on="newStateNameInput">
        </div>
      </form>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-default" ng-click="cancel()">Cancel</button>
    <button class="btn btn-success protractor-test-add-state-submit"
            ng-click="submit(newStateName)"
            ng-disabled="!isNewStateNameValid(newStateName)">
      Add State
    </button>
  </div>
</script>

<script type="text/ng-template" id="rules/ruleDescriptionEditor">
  <form class="form-inline" role="form">
    Answer
    <rule-type-selector class="protractor-test-rule-description" all-rule-types="allRuleTypes" local-value="currentRuleDescription" on-selection-change="onSelectNewRuleType()">
    </rule-type-selector>

    <span ng-repeat="item in ruleDescriptionFragments track by $index" class="form-group protractor-test-rule-description-fragment">
      <span ng-if="item.type == 'select'" style="color: black;">
        <select class="form-control" ng-model="currentRuleDefinition.inputs[item.varName]" ng-options="choice.id as (choice.val|convertRuleChoiceToPlainText|truncate) for choice in ruleDescriptionChoices" style="max-width: 250px;">
        </select>
      </span>

      <span ng-if="item.type != 'select' && item.type != 'noneditable'">
        <object-editor obj-type="<[item.type]>" is-editable="isEditable" always-editable="true" value="currentRuleDefinition.inputs[item.varName]" style="color: black;"></object-editor>
      </span>
      <span ng-if="item.type == 'noneditable'">
        <[item.text]>
      </span>
    </span>
  </form>
</script>
